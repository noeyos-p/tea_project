<!DOCTYPE html> <html xmlns:th="http://www.thymeleaf.org"> <head> <meta charset="UTF-8"> <title>추천 결과</title> </head> <body> <h1>추천 결과</h1>
<!-- 폼 전체를 감싸도록 이동 -->
<form id="saveForm"
      th:action="@{/userdata/save}"
      method="post"
      th:attr="data-csrf-param=${_csrf.parameterName}, data-csrf-token=${_csrf.token}, data-choose-url=@{/choose}"
      th:if="${result.teas != null and !#lists.isEmpty(result.teas)}"
      style="margin-top:16px;">

    <!-- 결과 메시지 -->
    <div th:if="${result != null}">
        <p><strong>결과 메시지:</strong></p>
        <p th:utext="${#strings.replace(result.message != null ? result.message : '', '\n', '<br/>')}"></p>
    </div>

    <!-- 추천 차 목록 -->
    <div>
        <p><strong>추천 차 목록:</strong></p>
        <ul>
            <li th:each="tea : ${result.teas}">
                <!-- 차 이름 버튼 -->
                <button type="button"
                        th:text="${tea.name}"
                        th:onclick="'selectTea(' + ${tea.id} + ');'"></button>

                <!-- 상세 정보 -->
                <div th:id="'detail_' + ${tea.id}" style="display:none; margin-left:20px; margin-top:6px;">
                    <p><strong>효능:</strong> <span th:text="${tea.content}"></span></p>
                    <p><strong>섭취법:</strong> <span th:text="${tea.eat}"></span></p>
                    <p><strong>주의사항:</strong> <span th:text="${tea.caution}"></span></p>
                </div>
            </li>
        </ul>
    </div>

    <!-- 선택된 teaId를 저장할 hidden input -->
    <input type="hidden" name="teaId" id="selectedTeaId" required>

    <!-- 체크리스트 유형에 따라 hidden 값 전달 -->
    <input type="hidden" th:name="${result.type == 'mood' ? 'moodId' : 'stateId'}"
           th:value="${result.resultId != null ? result.resultId : 0}"/>

    <!-- CSRF 토큰 -->
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <!-- 저장 버튼 -->
    <button type="submit">마이페이지에 저장하기</button>
</form>

<!-- 상세 정보 토글 및 선택 처리 -->
<script>
    function selectTea(id) {
        // 모든 상세정보 숨기기
        document.querySelectorAll('[id^="detail_"]').forEach(div => {
            div.style.display = 'none';
        });

        // 해당 tea의 상세정보 보이기
        const detailDiv = document.getElementById('detail_' + id);
        if (detailDiv) {
            detailDiv.style.display = 'block';
        }

        // 선택한 teaId를 hidden input에 저장
        const hiddenInput = document.getElementById('selectedTeaId');
        if (hiddenInput) {
            hiddenInput.value = id;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('saveForm');
        if (!form) return;

        form.addEventListener('submit', async (e) => {
            const teaId = document.getElementById('selectedTeaId').value;
            if (!teaId) {
                alert('차를 선택해주세요.');
                e.preventDefault();
                return;
            }

            e.preventDefault(); // 기본 제출 막고 fetch 먼저

            const csrfParam = form.dataset.csrfParam;
            const csrfToken = form.dataset.csrfToken;
            const chooseUrl = form.dataset.chooseUrl || '/choose';

            const params = new URLSearchParams();
            params.append('teaId', teaId);
            if (csrfParam && csrfToken) params.append(csrfParam, csrfToken);

            try {
                await fetch(chooseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    credentials: 'same-origin',
                    body: params.toString()
                });
            } catch (err) {
                // 실패해도 저장은 계속 진행
                console.error('choose increment failed', err);
            }

            form.submit(); // 원래 form 제출
        });
    });
</script>

<!-- 체크리스트로 돌아가기 링크 -->
<div style="margin-top:12px;">
    <a th:if="${result != null and result.type == 'mood'}" th:href="@{/mood/checklist}">무드 체크리스트로 돌아가기</a>
    <a th:if="${result != null and result.type == 'state'}" th:href="@{/state/checklist}">상태 체크리스트로 돌아가기</a>
    <span th:if="${result == null or (result.type != 'mood' and result.type != 'state')}">
        <a th:href="@{/mood/checklist}">무드 체크리스트</a> |
        <a th:href="@{/state/checklist}">상태 체크리스트</a>
    </span>
</div>